name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Go vet
        run: go vet ./internal/...

  unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Run unit tests
        run: go test -short -count=1 -coverprofile=coverage.out ./internal/...
      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage.out

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: nova
          POSTGRES_PASSWORD: nova
          POSTGRES_DB: nova
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U nova -d nova"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Run integration tests
        env:
          NOVA_PG_DSN: postgres://nova:nova@localhost:5432/nova?sslmode=disable
        run: go test -count=1 -run Integration ./internal/...

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: unit
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      - name: Build all services
        run: |
          CGO_ENABLED=0 go build -o /dev/null ./cmd/nova
          CGO_ENABLED=0 go build -o /dev/null ./cmd/comet
          CGO_ENABLED=0 go build -o /dev/null ./cmd/zenith
          CGO_ENABLED=0 go build -o /dev/null ./cmd/corona
          CGO_ENABLED=0 go build -o /dev/null ./cmd/nebula
          CGO_ENABLED=0 go build -o /dev/null ./cmd/aurora
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o /dev/null ./cmd/agent
